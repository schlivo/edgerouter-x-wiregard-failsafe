#!/bin/sh
# Load-Balance Transition Script
# This script is called by EdgeOS load-balance system when WAN interface status changes.
# It triggers the WireGuard failsafe script and optionally sends notifications.
#
# Installation:
#   1. Copy to /config/scripts/main-wan-down
#   2. chmod +x /config/scripts/main-wan-down
#   3. Configure in EdgeOS:
#      set load-balance group G transition-script /config/scripts/main-wan-down

set -u

# ================= CONFIGURATION =================
# Notification settings (optional)
# Set NOTIFY_ENABLED="true" to enable notifications
NOTIFY_ENABLED="false"

# ntfy.sh topic (recommended - simple, free push notifications)
# Create a unique topic name at https://ntfy.sh/
NTFY_TOPIC="your-unique-topic"

# Alternative: IFTTT webhook (uncomment to use instead of ntfy.sh)
# IFTTT_API_KEY="your-api-key"
# IFTTT_EVENT_NAME="wan_failover"

# ================= MAIN SCRIPT =================
RUN_CMD="/opt/vyatta/bin/vyatta-op-cmd-wrapper"

# Get current load-balance status for each interface
get_status() {
    local iface="$1"
    $RUN_CMD show load-balance status 2>/dev/null | \
        grep -A3 "interface.*: *${iface}" | \
        grep "status" | \
        awk '{print $3}' | \
        head -1
}

ETH0_STATUS=$(get_status "eth0")
ETH1_STATUS=$(get_status "eth1")

# Default to "unknown" if status detection fails
ETH0_STATUS="${ETH0_STATUS:-unknown}"
ETH1_STATUS="${ETH1_STATUS:-unknown}"

# Log the event
logger -t main-wan-down "Failover triggered: eth0=$ETH0_STATUS eth1=$ETH1_STATUS"

# ================= NOTIFICATIONS =================
if [ "$NOTIFY_ENABLED" = "true" ]; then
    # Send notification (non-blocking with timeout)
    if command -v curl >/dev/null 2>&1; then
        if [ -n "${NTFY_TOPIC:-}" ]; then
            # ntfy.sh notification (recommended)
            (
                curl -s --max-time 10 \
                    -d "WAN Failover: eth0=$ETH0_STATUS, eth1=$ETH1_STATUS" \
                    "https://ntfy.sh/${NTFY_TOPIC}?priority=high&title=EdgeRouter" \
                    >/dev/null 2>&1
            ) &
        elif [ -n "${IFTTT_API_KEY:-}" ]; then
            # IFTTT webhook notification (alternative)
            (
                curl -s --max-time 10 \
                    -X POST \
                    -H "Content-Type: application/json" \
                    -d "{\"value1\":\"WAN Failover\", \"value2\":\"eth0=$ETH0_STATUS\", \"value3\":\"eth1=$ETH1_STATUS\"}" \
                    "https://maker.ifttt.com/trigger/${IFTTT_EVENT_NAME}/with/key/${IFTTT_API_KEY}" \
                    >/dev/null 2>&1
            ) &
        fi
    fi
fi

# ================= WIREGUARD FAILSAFE =================
# Trigger WireGuard failsafe if script exists and is executable
# Run in background to not block the load-balance transition
if [ -x /config/scripts/wireguard-failsafe.sh ]; then
    logger -t main-wan-down "Triggering WireGuard failsafe script"
    /config/scripts/wireguard-failsafe.sh >/dev/null 2>&1 &
fi

exit 0
